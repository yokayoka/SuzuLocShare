<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Sharing locations on CS Maps - Mobile Optimized v2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  <!-- Ensure Leaflet CSS is definitely present (CDN first, then local as fallback) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha256-Rksm4bNQH3+iQG7ZQvQjvT6f3Jxusj6Ch2R8AflFhHY=" crossorigin="">
  <link rel="stylesheet" href="src/leaflet.css">

  <!-- Existing CSS deps -->
  <link rel="stylesheet" href="src/css/bootstrap.css">
  <link rel="stylesheet" href="src/plugins/easy-button.css">
  <link rel="stylesheet" href="src/plugins/L.Control.Sidebar.css">

  <!-- JS deps -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="src/jquery-3.2.0.min.js"></script>
  <script src="src/plugins/L.Control.Sidebar.js"></script>
  <script src="src/plugins/easy-button.js"></script>
  <script src="src/L.TileLayer.BetterWMS.js"></script>
  <script src="src/proj4.js"></script>
  <script src="https://code.jquery.com/jquery-2.2.3.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #mapdiv { height: 100dvh; width: 100%; }

    #side-bar {
      max-height: 100dvh;
      overflow-y: auto;
      background: #fff;
    }

    .leaflet-touch .leaflet-bar a {
      width: 42px; height: 42px;
      line-height: 42px;
      font-size: 16px;
    }
    .leaflet-popup-content { max-width: min(80vw, 320px); }

    /* Make sure top-left controls stack above map layers on small screens */
    .leaflet-top.leaflet-left { z-index: 1000; }

    @media (max-width: 768px) {
      #side-bar {
        position: absolute;
        top: 0; left: 0;
        width: 85%; max-width: 360px;
        z-index: 1200;
        border-right: 1px solid #ddd;
        box-shadow: 2px 0 10px rgba(0,0,0,0.08);
      }
      .leaflet-control { touch-action: manipulation; }
    }
  </style>
</head>
<body>
  <div id="side-bar" class="col-md-3">
    <button id='btnHome' class='btn btn-primary btn-block'>Homeへ移動</button>
    <h4>Zoom Level: <span id='zoom-level'></span></h4>
    <h4>Map Center: <span id='map-center'></span></h4>
    <h4>Mouse Location: <span id='mouse-location'></span></h4>
    <h4>登録座標: <span id='input-corrdinate'></span></h4>
    <label for="in_loc_name">地点名</label>
    <input type="text" name="loc_name" size="20" maxlength="30" id="in_loc_name">
    <h4>地点名を入力し地図上で場所をクリック下さい。<span id='input-comment'></span></h4>
    <h5><span id='url-value'></span></h5>
    <p><button type="button" id="btnCopyUrl">Copy</button></p>
    <p><button type="button" id="btnHelpUrl">使い方</button></p>
  </div>

  <div id="mapdiv" class="col-md-12"></div>

  <script src="src/draw_houkai.js"></script>
  <script src="src/draw_houkai_wjc.js"></script>
  <script src="src/draw_houkai_wjw.js"></script>

  <script>
    var mymap;
    var lyrGSI, lyrafCSMap, lyrbfCSMap, lyrGoogleHybrid, lyr20240923rain_wajimatobu_0924do_sokuho;
    var lyr20240923rain_wajimaseibu_0924do_sokuho, lyr20240923rain_wajima_0923do_sokuho;
    var lyrGSI_WajimaE240102, lyrGSI_WajimaM240105, lyrGSI_WajimaM240111, lyrGSI_WajimaW240111;
    var lyrGSI_Suzu240102, lyrGSI_Anamizu240105, lyrGSI_Nanao240105, lyrGSI_Nanao240117, lyrGSI60th;
    var geol50kLayer, landslideLayer, popHome, ctlAttribute, ctlScale, ctlSidebar, ctlEasybutton;
    var markerName, ini_x, ini_y, ini_z;

    ini_y = 37.422805; ini_x = 137.089547; ini_z = 15;

    $(document).ready(function () {
      mymap = L.map('mapdiv', {
        center: [ini_y, ini_x],
        zoom: 13,
        zoomControl: false,
        attributionControl: false,
        tap: true,
        tapTolerance: 15,
        scrollWheelZoom: false
      });

      // Zoom at top-right
      L.control.zoom({ position: 'topright' }).addTo(mymap);

      // Base/overlay layers
      lyrGSI = L.tileLayer("https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png",
        { opacity: 0.3, attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>" });
      lyrGoogleHybrid = L.tileLayer("https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}");
      lyrGSI60th = L.tileLayer("https://cyberjapandata.gsi.go.jp/xyz/ort_old10/{z}/{x}/{y}.png",
        { attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>" });

      lyr20240923rain_wajimatobu_0924do_sokuho = L.tileLayer(
        "https://cyberjapandata.gsi.go.jp/xyz/20240923rain_wajimatobu_0924do_sokuho/{z}/{x}/{y}.png",
        { attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>" });
      lyr20240923rain_wajimaseibu_0924do_sokuho = L.tileLayer(
        "https://cyberjapandata.gsi.go.jp/xyz/20240923rain_wajimaseibu_0924do_sokuho/{z}/{x}/{y}.png",
        { attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>" });
      lyr20240923rain_wajima_0923do_sokuho = L.tileLayer(
        "https://cyberjapandata.gsi.go.jp/xyz/20240923rain_wajima_0923do_sokuho/{z}/{x}/{y}.png",
        { attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>" });

      lyrGSI_WajimaE240102 = L.tileLayer(
        "https://cyberjapandata.gsi.go.jp/xyz/20240102noto_wazimahigashi_0102do/{z}/{x}/{y}.png",
        { attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>" });
      var lyrGSI_WajimaM240102 = L.tileLayer(
        "https://cyberjapandata.gsi.go.jp/xyz/20240102noto_wazimanaka_0102do/{z}/{x}/{y}.png",
        { attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>" });
      lyrGSI_WajimaM240105 = L.tileLayer(
        "https://cyberjapandata.gsi.go.jp/xyz/20240102_noto_wazimanaka_0105do/{z}/{x}/{y}.png",
        { attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>" });
      lyrGSI_WajimaM240111 = L.tileLayer(
        "https://cyberjapandata.gsi.go.jp/xyz/20240102noto_wazimanaka_0111do/{z}/{x}/{y}.png",
        { attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>" });
      lyrGSI_WajimaW240111 = L.tileLayer(
        "https://cyberjapandata.gsi.go.jp/xyz/20240102noto_wazimanishi_0111do/{z}/{x}/{y}.png",
        { attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>" });
      lyrGSI_Suzu240102 = L.tileLayer(
        "https://cyberjapandata.gsi.go.jp/xyz/20240102noto_suzu_0102do/{z}/{x}/{y}.png",
        { attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>" });
      var lyrGSI_Suzu240105 = L.tileLayer(
        "https://cyberjapandata.gsi.go.jp/xyz/20240102_noto_suzu_0105do/{z}/{x}/{y}.png",
        { attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>" });
      lyrGSI_Anamizu240105 = L.tileLayer(
        "https://cyberjapandata.gsi.go.jp/xyz/20240102_noto_anamizu_0105do/{z}/{x}/{y}.png",
        { attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>" });
      lyrGSI_Nanao240105 = L.tileLayer(
        "https://cyberjapandata.gsi.go.jp/xyz/20240102_noto_nanao_0105do/{z}/{x}/{y}.png",
        { attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>" });
      lyrGSI_Nanao240117 = L.tileLayer(
        "https://cyberjapandata.gsi.go.jp/xyz/20240102noto_nanao_0117do/{z}/{x}/{y}.png",
        { attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>" });

      geol50kLayer = L.tileLayer.betterWms('https://gbank.gsj.jp/geonavi/maptile/wmts/1.0.0/G50_10_003004006007suzumisaki-notoiida/default/EPSG900913/{z}/{y}/{x}.png', {
        layers: 'area', format: 'image/png', transparent: true, opacity: 0.7, zIndex: 2000,
        attribution: '<a href="https://www.gsj.jp/license/index.html" target="_blank">GSJ, AIST</a>'
      });

      landslideLayer = L.tileLayer('https://jmapweb3v.bosai.go.jp/map/xyz/landslide/{z}/{x}/{y}.png', {
        format: 'image/png', transparent: true, opacity: 0.7, minZoom: 5, maxZoom: 15,
        attribution: "<a href='http://www.j-shis.bosai.go.jp/JSHIS2/IMAGE/etc/landslide_v3_jp.png' target='_blank'>防災科研</a>"
      });

      lyrbfCSMap = L.tileLayer('https://www2.ffpri.go.jp/soilmap/tile/cs_noto/{z}/{x}/{y}.png',
        { attribution: "CSMap by FFPRI", minZoom: 8, maxZoom: 17 }).addTo(mymap);
      lyrafCSMap = L.tileLayer('https://rinya.geospatial.jp/tile/csmaptile_noto/{z}/{x}/{y}.png',
        { attribution: "Forestry Agency", minZoom: 8, maxZoom: 17 }).addTo(mymap);

      var objBaseMaps = {
        "災害前CS立体図": lyrbfCSMap,
        "災害後CS立体図": lyrafCSMap
      };
      var objOverlays = {
        "地理院地図": lyrGSI,
        "Google高解像度": lyrGoogleHybrid,
        "地理院写真2024年9月豪雨輪島東部": lyr20240923rain_wajimatobu_0924do_sokuho,
        "地理院写真2024年9月豪雨輪島西部": lyr20240923rain_wajimaseibu_0924do_sokuho,
        "地理院写真2024年9月豪雨輪島": lyr20240923rain_wajima_0923do_sokuho,
        "地理院写真輪島東地区1月2日": lyrGSI_WajimaE240102,
        "地理院写真輪島中地区1月5日": lyrGSI_WajimaM240105,
        "地理院写真輪島中地区1月11日": lyrGSI_WajimaM240111,
        "地理院写真輪島西地区1月11日": lyrGSI_WajimaW240111,
        "地理院写真珠洲地区1月2日": lyrGSI_Suzu240102,
        "地理院写真珠洲地区1月5日": lyrGSI_Suzu240105,
        "地理院写真穴水地区1月5日": lyrGSI_Anamizu240105,
        "地理院写真七尾地区1月5日": lyrGSI_Nanao240105,
        "国土地理院崩壊地1月2日珠洲輪島東": jsonHoukai,
        "国土地理院崩壊地1月6日珠洲輪島中央": jsonHoukai_wjc,
        "国土地理院崩壊地1月12日輪島西": jsonHoukai_wjw,
        "国土地理院60年代写真": lyrGSI60th,
        "能登飯田": geol50kLayer,
        "地すべり地形": landslideLayer
      };

      var collapsed = window.innerWidth <= 768;
      var ctlLayers = L.control.layers(objBaseMaps, objOverlays, { collapsed: collapsed, position: 'topleft' }).addTo(mymap);

      ctlAttribute = L.control.attribution({ position: 'bottomleft' }).addTo(mymap);
      ctlAttribute.addAttribution('OSM');
      ctlAttribute.addAttribution('&copy; <a href="http://millermountain.com">Miller Mountain LLC</a>');
      ctlScale = L.control.scale({ position: 'bottomleft', metric: false, maxWidth: 200 }).addTo(mymap);

      ctlSidebar = L.control.sidebar('side-bar').addTo(mymap);
      ctlEasybutton = L.easyButton('glyphicon-transfer', function () { ctlSidebar.toggle(); }).addTo(mymap);

      popHome = L.popup({ maxWidth: 200, keepInView: true });
      popHome.setLatLng([ini_y, ini_x]);
      popHome.setContent("<h2>珠洲市役所</h2><img src='img/suzu_office.jpg' width='200px'>");

      const url = new URL(location.href);
      const params = new URLSearchParams(url.search);
      var locName = params.get('p');
      var x = parseFloat(params.get('x'));
      var y = parseFloat(params.get('y'));
      if ((Number.isFinite(x)) && (x <= 180) && (x >= -180) && (Number.isFinite(y)) && (y <= 90) && (y >= -90)) {
        ini_x = x; ini_y = y;
        mymap.setView([ini_y, ini_x], ini_z);
        var locFlag = L.marker([ini_y, ini_x]).addTo(mymap);
        locFlag.bindPopup("<p>" + (locName || '') + "</p>").openPopup();
      } else {
        mymap.setView([ini_y, ini_x], ini_z);
      }

      mymap.on('click', function (e) {
        if (e.originalEvent.shiftKey) { alert(mymap.getZoom()); }
        else {
          $("#input-corrdinate").html(LatLngToArrayString(e.latlng));
          var myFlag = L.marker(e.latlng).addTo(mymap);
          markerName = $("#in_loc_name").val();
          if (markerName) {
            myFlag.bindPopup("<p>" + markerName + "</p>").openPopup();
            $("#url-value").html(setUrlValue(e.latlng, markerName));
            $("#input-comment").html('<p>copyボタンでURLをクリップボードにコピーします。</p>');
          }
        }
      });

      mymap.on('contextmenu', function (e) {
        var dtCurrentTime = new Date();
        L.marker(e.latlng).addTo(mymap).bindPopup(e.latlng.toString() + "<br>" + dtCurrentTime.toString());
      });

      mymap.on('zoomend', function () { $("#zoom-level").html(mymap.getZoom()); });
      mymap.on('moveend', function () { $("#map-center").html(LatLngToArrayString(mymap.getCenter())); });
      mymap.on('mousemove', function (e) { $("#mouse-location").html(LatLngToArrayString(e.latlng)); });

      $("#btnHome").click(function () {
        mymap.setView([37.43684769826554, 137.2606927861479], 16);
        mymap.openPopup(popHome);
      });

      $('#in_loc_name').change(function () { $("#input-comment").html('<p>地図上で場所をクリックして下さい。</p>'); });

      $("#btnCopyUrl").click(function () {
        var text = $('#url-value').text();
        var $textarea = $('<textarea></textarea>');
        $textarea.text(text);
        $(this).append($textarea);
        $textarea.select();
        document.execCommand('copy');
        $textarea.remove();
        $("#input-comment").html('<p>メールやSNSにペーストして場所を共有できます</p>');
      });

      $("#btnHelpUrl").click(function () { window.location = "https://sites.google.com/view/manual4suzulocshare"; });

      window.addEventListener('orientationchange', () => setTimeout(() => mymap.invalidateSize(), 250));
      window.addEventListener('resize',            () => setTimeout(() => mymap.invalidateSize(), 250));
      mymap.on('focus', () => mymap.scrollWheelZoom.enable());
      mymap.on('blur',  () => mymap.scrollWheelZoom.disable());
    });

    function LatLngToArrayString(ll) { return "[" + ll.lat.toFixed(5) + ", " + ll.lng.toFixed(5) + "]"; }
    function setUrlValue(ll, name) {
      var urlAdress = window.location.href.split('?')[0];
      return urlAdress + "?p=" + name + "&y=" + ll.lat.toFixed(5) + "&x=" + ll.lng.toFixed(5);
    }
  </script>
</body>
</html>
